#!/usr/bin/env ruby
# frozen_string_literal: true

repo_root = File.expand_path('..', __dir__)

if File.exist?(File.join(repo_root, 'Gemfile'))
  ENV['BUNDLE_GEMFILE'] ||= File.join(repo_root, 'Gemfile')
  require 'bundler/setup'
else
  # Installed as a gem: rely on RubyGems to resolve dependencies.
  require 'rubygems'
end

require 'optparse'

require_relative '../lib/slim_lsp'

options = {
  format: false,
  write: false,
  check: false,
  diagnose: false,
  config_path: nil,
  stylesheet_path: nil,
  node_path: nil
}

parser = OptionParser.new do |opts|
  opts.banner = 'Usage: slim-lsp [options]'

  opts.on('--version', 'Print version and exit') do
    sha = begin
      if ENV['SLIM_LSP_GIT_SHA']
        ENV['SLIM_LSP_GIT_SHA']
      elsif File.directory?(File.join(repo_root, '.git'))
        `git -C #{repo_root} rev-parse --short HEAD`.strip
      end
    rescue StandardError
      nil
    end

    version = SlimLsp::VERSION
    version = "#{version}+#{sha}" if sha && !sha.empty?
    puts version
    exit(0)
  end

  opts.on('--format [PATH]', 'Format Slim from PATH (or stdin) and output to stdout') do |path|
    options[:format] = true
    options[:format_path] = path
  end

  opts.on('--write', 'Write formatted output back to file when using --format PATH') do
    options[:write] = true
  end

  opts.on('--check', 'Exit with status 1 if formatting would change output') do
    options[:check] = true
  end

  opts.on('--diagnose [PATH]', 'Parse Slim and exit non-zero if syntax errors are found') do |path|
    options[:diagnose] = true
    options[:diagnose_path] = path
  end

  opts.on('--tailwind-config PATH', 'Path to tailwind.config.js') do |path|
    options[:config_path] = path
  end

  opts.on('--tailwind-stylesheet PATH', 'Path to Tailwind stylesheet') do |path|
    options[:stylesheet_path] = path
  end

  opts.on('--node PATH', 'Path to node executable') do |path|
    options[:node_path] = path
  end
end

parser.parse!(ARGV)

if options[:diagnose]
  source_path = options[:diagnose_path]
  input = if source_path.nil? || source_path == '-'
            STDIN.read
          else
            File.read(source_path)
          end

  begin
    Slim::Engine.new.call(input)
    exit(0)
  rescue StandardError => e
    warn(e.message)
    exit(1)
  end
end

if options[:format]
  input = nil
  source_path = options[:format_path]

  if source_path.nil? || source_path == '-'
    input = STDIN.read
  else
    input = File.read(source_path)
  end

  config = Marshal.load(Marshal.dump(SlimLsp::Server::DEFAULT_CONFIG))
  config['tailwind']['configPath'] = options[:config_path] if options[:config_path]
  config['tailwind']['stylesheetPath'] = options[:stylesheet_path] if options[:stylesheet_path]
  config['tailwind']['nodePath'] = options[:node_path] if options[:node_path]

  workspace_root = source_path && source_path != '-' ? File.expand_path(File.dirname(source_path)) : Dir.pwd
  formatter = SlimLsp::Formatter.new(config: config, workspace_root: workspace_root)
  formatted = formatter.format(input)

  if options[:check]
    exit(formatted == input ? 0 : 1)
  end

  if options[:write] && source_path && source_path != '-'
    File.write(source_path, formatted)
  else
    puts formatted
  end

  exit(0)
end

SlimLsp::Server.new.run
